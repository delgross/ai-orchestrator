version: '3.8'

services:
  # MongoDB - Required for LibreChat
  mongodb:
    image: mongo:7.0
    container_name: librechat-mongodb
    restart: unless-stopped
    ports:
      - "27017:27017"
    volumes:
      - mongodb_data:/data/db
    environment:
      - MONGO_INITDB_DATABASE=librechat
    networks:
      - librechat-network
    healthcheck:
      test: echo 'db.runCommand("ping").ok' | mongosh localhost:27017/librechat --quiet
      interval: 10s
      timeout: 5s
      retries: 5

  # Meilisearch - For search functionality
  meilisearch:
    image: getmeili/meilisearch:v1.5
    container_name: librechat-meilisearch
    restart: unless-stopped
    ports:
      - "7700:7700"
    volumes:
      - meilisearch_data:/meili_data
    environment:
      - MEILI_MASTER_KEY=ac28743ede6e7114d89983481f81f71860bbb8635b1538f259eeb2a96dc2fd5e
      - MEILI_ENV=development
    networks:
      - librechat-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:7700/health"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Redis - For caching and sessions (optional but recommended)
  redis:
    image: redis:7-alpine
    container_name: librechat-redis
    restart: unless-stopped
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    networks:
      - librechat-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # LibreChat API
  api:
    image: ghcr.io/danny-avila/librechat:latest
    container_name: librechat-api
    restart: unless-stopped
    depends_on:
      mongodb:
        condition: service_healthy
      meilisearch:
        condition: service_healthy
      redis:
        condition: service_healthy
    ports:
      - "3080:3080"
    volumes:
      - librechat_data:/app/librechat_data
    entrypoint: >
      sh -c "
        if [ -f /app/librechat_data/librechat.yaml ]; then
          rm -rf /app/librechat.yaml 2>/dev/null || true;
          cp /app/librechat_data/librechat.yaml /app/librechat.yaml;
        fi &&
        exec npm run backend
      "
    environment:
      # Database
      - MONGO_URI=mongodb://mongodb:27017/librechat
      
      # Redis
      - REDIS_URI=redis://redis:6379
      
      # Meilisearch
      - MEILI_HOST=http://meilisearch:7700
      - MEILI_MASTER_KEY=ac28743ede6e7114d89983481f81f71860bbb8635b1538f259eeb2a96dc2fd5e
      
      # App settings
      - NODE_ENV=production
      - DOMAIN_CLIENT=http://localhost:3080
      - DOMAIN_SERVER=http://localhost:3080
      
      # Security (CHANGE THESE!)
      - JWT_SECRET=dc537909a6ad8b1525c4d7461baf7c648ff6795ed16859daa23f42fa8efb5159
      - JWT_REFRESH_SECRET=95066b31ad3ad1695692f62475d5042b7e15dc1d5fc0b312870e67d0aeb92cfe
      - JWT_REFRESH_EXPIRATION=30d
      - JWT_EXPIRATION=15m
      
      # Admin user (first user created will be admin)
      - ALLOW_REGISTRATION=true
      - ALLOW_SOCIAL_LOGIN=false
      
      # File uploads
      - FILE_UPLOAD_SIZE_LIMIT=10485760
      - FILE_UPLOAD_PATH=/app/librechat_data/files
      
      # Logging
      - DEBUG_LOGGING=false
    extra_hosts:
      - "host.docker.internal:host-gateway"
    networks:
      - librechat-network
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3080/api/health', (r) => { process.exit(r.statusCode === 200 ? 0 : 1) })"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s


networks:
  librechat-network:
    driver: bridge

volumes:
  mongodb_data:
    driver: local
  meilisearch_data:
    driver: local
  redis_data:
    driver: local
  librechat_data:
    driver: local
  librechat_config:
    external: true
    name: librechat-config

