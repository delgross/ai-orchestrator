<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Questionable Insight Dashboard</title>
    <link rel="stylesheet" href="styles.css?v=2.9.1">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&family=JetBrains+Mono:wght@400;500&display=swap"
        rel="stylesheet">
    <link rel="icon"
        href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>‚ùì</text></svg>">
</head>

<body class="space-theme">
    <!-- Fixed Indicator Strip (Top) -->
    <header class="indicator-strip glass">
        <div class="brand">
            <div class="logo-text">?</div>
            <h1>QUESTIONABLE INSIGHT</h1>
            <div id="clock" class="clock">00:00:00</div>
            <div class="status-groups-compact">
                <div class="status-item" id="status-router" title="Router Status">
                    <span class="indicator unknown"></span> <span class="value">ROUTER</span>
                </div>
                <div class="status-item" id="status-mcp-tools" title="MCP Interface">
                    <span class="indicator unknown"></span> <span class="value">TOOLS</span>
                </div>
                <div class="status-item" id="status-mcp" title="Agent Core">
                    <span class="indicator unknown"></span> <span class="value">AGENT</span>
                </div>
                <div class="status-item" id="status-ollama" title="Ollama (LLM)">
                    <span class="indicator unknown"></span> <span class="value">LLM</span>
                </div>
                <div class="status-item" id="status-db" title="SurrealDB Memory">
                    <span class="indicator unknown"></span> <span class="value">DB</span>
                </div>
                <!-- New Memory & Ingestion Indicators -->
                <div class="status-item rag" id="status-rag" title="RAG Query Engine">
                    <span class="indicator unknown"></span> <span class="value">RAG</span>
                </div>
                <div class="status-item" id="status-memory-engine" title="Memory Engine (State)">
                    <span class="indicator unknown"></span> <span class="value">MEM</span>
                </div>
                <div class="status-item" id="status-data-ingest" title="Data Ingestion Pipeline">
                    <span class="indicator unknown"></span> <span class="value">INGEST</span>
                </div>
                <div class="status-item" id="status-internet" title="Internet Connectivity">
                    <span class="indicator unknown"></span> <span class="value">NET</span>
                </div>
                <div class="status-item" id="status-budget" title="Daily Budget">
                    <span class="indicator unknown"></span> <span class="value">BUDGET</span>
                </div>
            </div>
        </div>
    </header>

    <!-- System Health Sentinel (Persistent Alert) -->
    <div id="system-sentinel" class="system-sentinel glass" style="display: none;">
        <div class="sentinel-content">
            <span class="sentinel-icon">‚ö†Ô∏è</span>
            <div class="sentinel-body">
                <div class="sentinel-title">SYSTEM DEGRADED</div>
                <div class="sentinel-message" id="sentinel-msg">Loading health context...</div>
            </div>
            <div class="sentinel-actions">
                <button class="action-btn sm primary"
                    onclick="dismissAlert('system-sentinel', document.getElementById('sentinel-msg').innerText)">
                    Acknowledge
                </button>
            </div>
        </div>
    </div>

    <!-- Quick Action / Launch Strip -->
    <div class="launch-strip glass">
        <button class="action-btn sm" onclick="location.reload()" title="Hard Refresh Dashboard">
            <span class="icon">üîÉ</span> Refresh UI
        </button>
        <button class="action-btn sm" onclick="window.open('/v2/mcp_wizard.html', '_blank')">
            <span class="icon">‚ú®</span> Import MCP Server
        </button>
        <button class="action-btn sm" onclick="window.location.href='/v2/chat_debug.html'"
            title="Graph Visualization & Debugging">
            <span class="icon">üï∏Ô∏è</span> Graph View
        </button>
        <button class="action-btn sm" id="btn-reload-mcp-top" title="Reload MCP Servers">
            <span class="icon">üîÑ</span> Reload MCP
        </button>
        <button class="action-btn sm" id="btn-toggle-auto-top">
            <span class="icon">ü§ñ</span> Auto: <span id="lbl-auto">ON</span>
        </button>
        <button class="action-btn sm" id="btn-trigger-backup-top" title="Run Manual Backup">
            <span class="icon">üíæ</span> Backup
        </button>
        <button class="action-btn sm" id="btn-health-check">
            <span class="icon">ü©∫</span> Run Health Check
        </button>
        <div class="divider"></div>
        <button class="action-btn sm"
            onclick="fetch('/admin/system/process/router/restart', {method:'POST'}).then(() => alert('Router restarting...'))"
            title="Restart Router Process">
            <span class="icon">üîÑ</span> Router
        </button>
        <button class="action-btn sm"
            onclick="fetch('/admin/system/process/agent/restart', {method:'POST'}).then(() => alert('Agent restarting...'))"
            title="Restart Agent Process">
            <span class="icon">üß†</span> Agent
        </button>
    </div>

    <main class="dashboard-container">
        <!-- Sidebar Widget: Anomaly Inbox -->
        <div id="anomaly-widget" class="glass"
            style="margin-bottom: 10px; padding: 10px; cursor: pointer; border-left: 3px solid var(--text-secondary); display:none;"
            onclick="switchTab('anomalies')">
            <div style="font-size: 0.8rem; font-weight: bold;">System Health</div>
            <div id="anomaly-widget-status" style="font-size: 0.9rem;">No Active Issues</div>
        </div>

        <!-- Tab Navigation -->
        <nav class="tab-strip glass">
            <button class="tab-link active" data-tab="overview">
                <span class="icon">üìä</span> Overview
            </button>
            <button class="tab-link" data-tab="ollama">
                <span class="icon">ü¶ô</span> Ollama
            </button>
            <button class="tab-link" data-tab="tools">
                <span class="icon">üîß</span> MCP Servers
            </button>
            <button class="tab-link" data-tab="cost" style="display:none;">
                <span class="icon">üí∞</span> Cost
            </button>
            <button class="tab-link" data-tab="docs">
                <span class="icon">üìö</span> Docs
            </button>
            <button class="tab-link" data-tab="config" style="display:none;">
                <span class="icon">‚öôÔ∏è</span> Config
            </button>
            <button class="tab-link" data-tab="misc" style="display:none;">
                <span class="icon">üß©</span> Misc
            </button>
            <button class="tab-link" data-tab="chat">
                <span class="icon">üí¨</span> Chat
            </button>
            <button class="tab-link" data-tab="memory">
                <span class="icon">üß†</span> Memory
            </button>
            <button class="tab-link" data-tab="logs">
                <span class="icon">üìù</span> Logs
            </button>
            <button class="tab-link" data-tab="breakers">
                <span class="icon">‚ö°</span> Breakers
            </button>
            <button class="tab-link" data-tab="anomalies">
                <span class="icon">‚ö†Ô∏è</span> Anomalies
            </button>
            <button class="tab-link" data-tab="diagnostics-view">
                <span class="icon">ü©∫</span> Diagnostics
            </button>
        </nav>

        <!-- View Content Area -->
        <section class="tab-views">
            <!-- Chat Tab -->
            <div id="chat" class="tab-content">
                <div class="card glass wide full-height flex-col">
                    <div class="card-header">
                        <h3>Direct Router Chat</h3>
                        <div class="flex-row-center">
                            <select id="chat-model-select" class="config-select">
                                <option value="agent:mcp">Orchestrator (Agent)</option>
                                <option value="router">Raw Router</option>
                            </select>
                            <span id="chat-status" class="status-indicator">Ready</span>
                            <span id="chat-live-log" class="chat-live-log">(Log Area Ready)</span>
                        </div>
                    </div>
                    <div id="chat-messages" class="chat-container mono">
                        <div class="chat-message system">System: Ready to connect to Port 5455.</div>
                    </div>
                    <div class="chat-input-area">
                        <button id="btn-chat-mic" class="action-btn sm" title="Voice Input">üé§</button>
                        <textarea id="chat-input" class="code-editor"
                            placeholder="Type your message... (Shift+Enter to send)"></textarea>
                        <button id="btn-chat-send" class="action-btn primary">Send</button>
                    </div>
                    <div style="margin-top: 10px; display: flex; gap: 15px; align-items: center;">
                        <label class="tts-label">
                            <input type="checkbox" id="chat-tts-toggle"> üîä Read Responses Aloud
                        </label>
                    </div>
                </div>
            </div>
            <!-- Anomalies Tab -->
            <div id="anomalies" class="tab-content">
                <div class="card glass wide full-height flex-col">
                    <div class="card-header">
                        <h3>Anomaly Inbox</h3>
                        <div class="flex-row-center">
                            <span id="anomaly-count-badge" class="badge">0 New</span>
                            <button class="action-btn sm" onclick="fetchAnomalies()">Refresh</button>
                        </div>
                    </div>
                    <div class="table-container flex-grow">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Time</th>
                                    <th>Severity</th>
                                    <th>Metric</th>
                                    <th>Deviation</th>
                                    <th>Status</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody id="anomaly-table-body">
                                <tr>
                                    <td colspan="6" class="text-center">Loading...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <!-- Memory Tab -->
            <div id="memory" class="tab-content">
                <div class="card glass wide full-height flex-col">
                    <div class="card-header">
                        <h3>Orchestrator Memory (SurrealDB)</h3>
                        <div class="flex-row-center">
                            <div id="memory-functioning-indicator" class="status-item"
                                style="margin-right:15px; font-size:0.8rem;">
                                <span class="indicator unknown"></span> <span class="value">STATUS: --</span>
                            </div>
                            <input type="text" id="memory-search-input" placeholder="Search facts...">
                            <button class="action-btn sm" onclick="fetchMemoryFacts()">Search</button>
                        </div>
                    </div>
                    <div id="memory-results" class="flex-grow scroll-y p-1">
                        <div class="placeholder-box">Loading facts...</div>
                    </div>
                </div>
            </div>
            <!-- Overview Tab -->
            <div id="overview" class="tab-content active show">
                <div class="grid-layout">
                    <!-- System Role & Model Orchestration (Left / Top) -->
                    <div class="card glass wide full-width" style="grid-column: span 2;">
                        <div class="card-header">
                            <h3>System Role & Model Orchestration</h3>
                            <div class="flex-row-center">
                                <button class="action-btn sm" onclick="openRoleConfigModal()">Configure Models</button>
                                <button class="action-btn sm" onclick="fetchSystemRoles()">Refresh</button>
                            </div>
                        </div>
                        <div class="role-table-container">
                            <table class="role-table">
                                <thead>
                                    <tr>
                                        <th>Role</th>
                                        <th>Current Assigned Model</th>
                                        <!-- Actions removed from Overview -->
                                    </tr>
                                </thead>
                                <tbody id="roles-table-body">
                                    <tr>
                                        <td colspan="2" class="text-center">Loading Roles...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Active Ports & Connectivity -->
                    <div class="card">
                        <h3>Active Ports & Connectivity</h3>
                        <div style="font-size: 0.9em; color: var(--text-secondary); margin-bottom: 10px;">
                            Critical endpoints for connecting external tools to the Orchestrator.
                        </div>
                        <table class="status-table">
                            <thead>
                                <tr>
                                    <th align="left">Port</th>
                                    <th align="left">Service</th>
                                    <th align="left">Function</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr style="border-bottom: 1px solid rgba(255,255,255,0.05);">
                                    <td class="mono" style="color:var(--accent-ok); padding:12px;">5455</td>
                                    <td style="font-weight:600; padding:12px;">Router (Gateway)</td>
                                    <td style="padding:12px;">Main Entry Point & API Gateway.</td>
                                </tr>
                                <tr style="border-bottom: 1px solid rgba(255,255,255,0.05);">
                                    <td class="mono" style="color:var(--accent-ok); padding:12px;">5460</td>
                                    <td style="font-weight:600; padding:12px;">Agent Runner</td>
                                    <td style="padding:12px;">The Brain. Handles MCP tools & logic.</td>
                                </tr>
                                <tr style="border-bottom: 1px solid rgba(255,255,255,0.05);">
                                    <td class="mono" style="color:var(--accent-warn); padding:12px;">11434</td>
                                    <td style="font-weight:600; padding:12px;">Ollama</td>
                                    <td style="padding:12px;">Local LLM Engine (Backend).</td>
                                </tr>
                                <tr style="border-bottom: 1px solid rgba(255,255,255,0.05);">
                                    <td class="mono" style="color:var(--text-secondary); padding:12px;">8000</td>
                                    <td style="font-weight:600; padding:12px;">SurrealDB</td>
                                    <td style="padding:12px;">Memory & Vector Database.</td>
                                </tr>
                                <tr style="border-bottom: 1px solid rgba(255,255,255,0.05);">
                                    <td class="mono" style="color:var(--text-main); padding:12px;">5555</td>
                                    <td style="font-weight:600; padding:12px;">RAG Engine</td>
                                    <td style="padding:12px;">Knowledge Base Query Engine.</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- CLOUD UPLINK (New) -->
                    <div class="card bg-dark text-white mb-3" style="border: 1px solid var(--glass-border);">
                        <div
                            class="card-header border-bottom border-secondary d-flex justify-content-between align-items-center">
                            <h3>H100 Uplink</h3>
                            <span class="badge uplink-badge" id="cloud-status-badge">OFFLINE</span>
                        </div>
                        <div class="card-body p-0">
                            <div id="cloud-terminal" class="terminal-box">
                                > Listening for H100 telemetry...
                            </div>
                        </div>
                    </div>

                    <!-- Metrics Card -->
                    <div class="card glass tall">
                        <h3>System Metrics</h3>
                        <div class="metrics-visual">
                            <div class="chart-placeholder">
                                <div class="chart-bar" style="height: 40%"></div>
                                <div class="chart-bar" style="height: 60%"></div>
                                <div class="chart-bar" style="height: 30%"></div>
                                <div class="chart-bar" style="height: 80%"></div>
                                <div class="chart-bar" style="height: 50%"></div>
                            </div>
                        </div>
                        <div class="metric-row">
                            <span class="label">Total Requests</span>
                            <span class="value big" id="metric-requests">0</span>
                        </div>
                        <div class="metric-row">
                            <span class="label">Avg Latency</span>
                            <span class="value big" id="metric-latency">0ms</span>
                        </div>
                        <div class="metric-row">
                            <span class="label">Cache Hit Rate</span>
                            <span class="value big" id="metric-cache">0%</span>
                        </div>
                        <div class="metric-row">
                            <span class="label">Error Rate</span>
                            <span class="value big" id="metric-errors">0%</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Ollama Manager Tab -->
            <div id="ollama" class="tab-content">
                <div class="card glass wide full-height">
                    <div class="card-header">
                        <h3>Ollama Model Management</h3>
                        <div class="status-msg" id="ollama-status-msg"></div>
                    </div>
                    <div id="ollama-models-grid" class="mcp-grid">
                        <!-- Populated by JS -->
                        <div class="placeholder-box">Loading models...</div>
                    </div>
                </div>
            </div>

            <!-- Documents Tab -->
            <div id="docs" class="tab-content">
                <div class="grid-layout">
                    <!-- File List -->
                    <div class="card glass" style="max-height: 80vh; overflow-y: auto;">
                        <h3>Available Documents</h3>
                        <div id="docs-list" class="task-list">
                            <div class="placeholder-box">Loading docs...</div>
                        </div>
                    </div>
                    <!-- Viewer -->
                    <div class="card glass wide" style="max-height: 80vh; overflow-y: auto;">
                        <h3 id="doc-viewer-title">Reader</h3>
                        <div id="doc-viewer-content" class="md-content">
                            Select a document to view.
                        </div>
                    </div>
                </div>
            </div>

            <!-- MCP Tools Tab -->
            <div id="tools" class="tab-content">
                <div class="card glass wide full-height">
                    <div class="card-header">
                        <h3>MCP Servers & Tools</h3>
                        <div class="search-box">
                            <input type="text" id="tool-search" placeholder="Filter servers...">
                            <div class="flex-row-center">
                                <button class="action-btn sm" id="btn-reload-mcp"
                                    onclick="fetch('/admin/reload-mcp', {method:'POST'}).then(()=>showNotification('MCP Reloaded'))">
                                    üîÑ Reload Servers
                                </button>
                            </div>
                        </div>
                        <!-- Ingestion Controller -->
                        <!-- Ingestion Controller (Permanent) -->
                        <div id="ingestion-controller" class="card glass"
                            style="margin-bottom: 20px; border: 1px solid var(--glass-border);">
                            <div style="display:flex; justify-content:space-between; align-items:center;">
                                <div>
                                    <h4 id="ingest-status-title" style="margin:0;">Ingestion Pipeline</h4>
                                    <div id="ingest-pause-reason"
                                        style="font-size:0.85rem; margin-top:4px; color:var(--text-secondary);">
                                        Monitoring...
                                    </div>
                                </div>
                                <div id="ingestion-action-buttons" style="display:flex; gap:8px;">
                                    <button id="btn-pause-ingest" class="action-btn sm" onclick="pauseIngestion()">
                                        ‚è∏Ô∏è Pause
                                    </button>
                                    <button id="btn-resume-ingest" class="action-btn sm primary"
                                        onclick="resumeIngestion()" style="display:none;">
                                        ‚ñ∂Ô∏è Resume
                                    </button>
                                    <button id="btn-clear-resume" class="action-btn sm primary" style="display:none;"
                                        onclick="clearAndResumeIngestion()">‚ö†Ô∏è Clear & Resume</button>
                                </div>
                            </div>
                        </div>

                        <!-- MCP Server Status (New) -->
                        <div id="mcp-server-status-card" class="card glass"
                            style="margin-bottom: 20px; border: 1px solid var(--glass-border); display:none;">
                            <div style="display:flex; justify-content:space-between; align-items:center;">
                                <div>
                                    <h4 style="margin:0; color:var(--accent-neon);">MCP Server Active</h4>
                                    <div style="font-size:0.85rem; color:var(--text-secondary); margin-top:4px;">
                                        Port: <span class="mono">5460</span> (SSE)
                                    </div>
                                </div>
                                <div id="mcp-connected-clients" style="font-size:0.85rem; text-align:right;">
                                    No Clients Connected
                                </div>
                            </div>
                        </div>

                        <div id="mcp-servers-list" class="mcp-grid">
                            <div class="placeholder-box">Loading MCP Servers...</div>
                        </div>
                    </div>
                </div>

                <!-- Cost Tab -->
                <div id="cost" class="tab-content">
                    <div class="card glass">
                        <h3>Daily API Budget</h3>
                        <div
                            style="display:flex; justify-content:space-between; align-items:flex-end; margin-bottom:1rem;">
                            <div>
                                <div id="costDisplay" class="cost-value-big">Loading...</div>
                                <div id="limitDisplay" class="cost-limit">Limit: --</div>
                            </div>
                            <div class="text-right">
                                <div id="percentDisplay" class="cost-percent">--%</div>
                                <div class="cost-label-sm">Used Today</div>
                            </div>
                        </div>

                        <div class="cost-progress-bg">
                            <div id="costBar" class="progress-fill"></div>
                        </div>

                        <p style="margin-top:1rem; font-size:0.9rem; color:var(--text-secondary);">
                            Estimates based on input/output tokens. Actual provider billing may vary slightly.
                            Resets daily at 00:00 UTC.
                        </p>
                        <button class="action-btn sm" onclick="refreshCost()" style="margin-top:1rem;">üîÑ Refresh
                            Cost</button>
                    </div>
                </div>

                <!-- Misc Tab -->
                <div id="misc" class="tab-content">
                    <div class="grid-layout">
                        <div class="card glass wide">
                            <h3>Full Provider Status</h3>
                            <div id="llm-status-list-misc" class="mcp-grid">
                                <div class="placeholder-box">Loading Status...</div>
                            </div>
                        </div>

                        <div class="card glass">
                            <h3>System Controls</h3>
                            <div style="display:flex; flex-direction:column; gap:0.8rem;">
                                <button class="action-btn"
                                    onclick="fetch('/admin/reload', {method:'POST'}).then(()=>location.reload())">
                                    ‚ö° Hot Reload Config
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Config Edit Tab (Smart) -->
                <div id="config" class="tab-content">
                    <div class="grid-layout">
                        <!-- Control Panel -->
                        <div class="card glass" style="grid-column: span 1;">
                            <h3>‚ú® Smart Config Manager</h3>
                            <p style="color:var(--text-secondary); font-size:0.9rem; margin-bottom:1rem;">
                                Describe the changes you want (e.g., "Remove the fetch-docker server", "Set timeout to
                                600",
                                "Enable debug mode").
                                The Agent will safely edit <code>config.yaml</code> for you.
                            </p>

                            <textarea id="config-instruction" class="code-editor"
                                style="height:150px; margin-bottom:1rem;"
                                placeholder="Type your instructions here..."></textarea>

                            <div class="controls"
                                style="display:flex; justify-content:space-between; align-items:center;">
                                <button class="action-btn primary" id="btn-smart-config" onclick="runSmartConfig()">ü§ñ
                                    Apply
                                    Changes</button>
                                <span id="smart-config-status" class="status-msg"></span>
                            </div>

                            <div id="smart-config-log" class="log-viewer mono">
                                Agent output will appear here...
                            </div>
                        </div>

                        <!-- File Viewer (Read Only reference) -->
                        <div class="card glass" style="grid-column: span 1;">
                            <div class="card-header">
                                <h3>File Manager</h3>
                                <div class="flex-row-center">
                                    <select id="config-file-selector" class="config-select" style="max-width: 150px;">
                                        <option value="" disabled selected>Select...</option>
                                    </select>
                                    <button class="action-btn sm" id="btn-save-config" title="Save File to Disk">
                                        <span class="icon">üíæ</span> Save
                                    </button>
                                    <button class="action-btn sm" onclick="loadConfigFile()" title="Reload from Disk">
                                        <span class="icon">üîÑ</span>
                                    </button>
                                </div>
                            </div>
                            <textarea id="config-editor" class="code-editor mono"
                                placeholder="Loading config..."></textarea>
                        </div>
                    </div>
                </div>

                <!-- Logs Tab -->
                <div id="logs" class="tab-content">
                    <div class="card glass wide full-height">
                        <div class="card-header">
                            <h3>System Logs (Live Stream)</h3>
                            <div class="log-controls">
                                <button class="action-btn sm" id="btn-refresh-logs">Refresh Tail</button>
                                <button class="action-btn sm" id="btn-clear-logs">Clear View</button>
                            </div>
                        </div>
                        <div id="log-container" class="log-viewer mono">
                            <div class="log-entry info">System: Initializing log stream...</div>
                        </div>
                    </div>
                </div>

                <!-- Breakers Tab -->
                <div id="breakers" class="tab-content">
                    <div class="card glass wide full-height">
                        <div class="card-header">
                            <h3>Circuit Breaker Status</h3>
                            <div class="search-box">
                                <div class="flex-row-center">
                                    <button class="action-btn sm" id="btn-reload-breakers" onclick="fetchBreakerData()">
                                        üîÑ Refresh Status
                                    </button>
                                    <button class="action-btn sm primary"
                                        onclick="if(confirm('Reset ALL Circuit Breakers?')) fetch('/admin/circuit-breaker/reset-all', {method:'POST'}).then(() => fetchBreakerData())">
                                        ‚ö†Ô∏è Reset ALL
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="role-table-container">
                            <table class="role-table">
                                <thead>
                                    <tr>
                                        <th>Service / Server</th>
                                        <th>State</th>
                                        <th>Failures</th>
                                        <th>Last Error</th>
                                        <th>Cooldown</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody id="breaker-table-body">
                                    <tr>
                                        <td colspan="6" class="text-center">Loading Breakers...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- DIAGNOSTICS VIEW (Phase 25 & 25b) -->
                <div id="diagnostics-view" class="tab-content">
                    <div class="grid-layout">
                        <!-- Stream Terminal -->
                        <div class="card terminal-card" style="grid-column: span 3; height: 60vh;">
                            <div class="card-header">
                                <h3>üß† Diagnostician Stream (Live)</h3>
                                <div class="flex-row-center">
                                    <span class="status-indicator active">Connected</span>
                                </div>
                            </div>
                            <div id="diag-stream-log" class="log-window mono" style="height: 100%;">
                                <div class="log-entry info">Connecting to Diagnostician stream...</div>
                            </div>
                        </div>
                    </div>
                </div>
        </section>
    </main>

    <!-- Cleaned Footer -->
    <footer class="toggle-strip glass">
        <div class="mode-indicator" id="system-mode">
            MODE: <span class="value">PRODUCTION</span>
        </div>
    </footer>

    <!-- Tool Modal -->
    <div id="tool-modal" class="modal-overlay">
        <div class="modal glass">
            <div class="modal-header">
                <h3 id="modal-title">Tool Details</h3>
                <button class="close-modal" onclick="closeToolsModal()">&times;</button>
            </div>
            <div class="modal-body" id="modal-content">
                <!-- Content injected here -->
            </div>
        </div>
    </div>

    <div id="role-config-modal" class="modal-overlay">
        <div class="modal glass" style="max-width: 800px; width: 90%;">
            <div class="modal-header">
                <h3>Configure System Roles</h3>
                <button class="close-modal" onclick="closeRoleConfigModal()">&times;</button>
            </div>
            <div class="modal-body">
                <table class="role-table">
                    <thead>
                        <tr>
                            <th>Role</th>
                            <th>Current Model</th>
                            <th>New Assignment</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="role-config-table-body">
                        <!-- Populated by JS -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Models Modal (Still kept for view all if needed) -->
    <div id="model-modal" class="modal-overlay">
        <div class="modal glass">
            <div class="modal-header">
                <h3 id="model-modal-title">Available Models</h3>
                <button class="close-modal" onclick="closeToolsModal()">&times;</button>
            </div>
            <div class="modal-body" id="model-modal-content">
            </div>
        </div>
    </div>

    <!-- SYSTEM LOGS VIEW -->
    <div id="logs-view" class="view" style="display: none;">
        <div class="card terminal-card">
            <h2>System Logs</h2>
            <div id="system-logs" class="log-window"></div>
            <div class="log-controls">
                <button class="btn" onclick="clearLogs()">Clear</button>
                <label><input type="checkbox" id="auto-scroll" checked> Auto-scroll</label>
            </div>
        </div>
    </div>

    <!-- DIAGNOSTICS VIEW (Phase 25 & 25b) -->
    <div id="diagnostics-view" class="view" style="display: none;">
        <!-- Controls -->
        <div style="margin-bottom: 20px; display: flex; justify-content: flex-end;">
            <button class="btn primary" onclick="forceReexamine()">
                <span class="icon">üîÑ</span> Re-Examine System (Reset Metrics)
            </button>
        </div>

        <!-- Top Metrics Row -->
        <div class="grid-layout">
            <div class="card status-card">
                <h2>Throughput</h2>
                <div class="status-indicator">
                    <div class="status-item">
                        <span class="label">RPS</span>
                        <span class="value" id="diag-rps">0.0</span>
                    </div>
                    <div class="status-item">
                        <span class="label">Tokens/Sec</span>
                        <span class="value" id="diag-tps">0.0</span>
                    </div>
                    <div class="status-item">
                        <span class="label">Latency P99</span>
                        <span class="value" id="diag-p99">0ms</span>
                    </div>
                </div>
            </div>

            <div class="card status-card">
                <h2>Cache Efficiency</h2>
                <div class="status-indicator">
                    <div class="status-item">
                        <span class="label">Hit Rate</span>
                        <span class="value" id="diag-cache-rate">0%</span>
                    </div>
                    <div class="status-item">
                        <span class="label">Hits</span>
                        <span class="value" id="diag-cache-hits">0</span>
                    </div>
                    <div class="status-item">
                        <span class="label">Misses</span>
                        <span class="value" id="diag-cache-misses">0</span>
                    </div>
                </div>
            </div>

            <div class="card status-card">
                <h2>Concurrency</h2>
                <div class="status-indicator">
                    <div class="status-item">
                        <span class="label">Active</span>
                        <span class="value" id="diag-active">0</span>
                    </div>
                    <div class="status-item">
                        <span class="label">Wait Time</span>
                        <span class="value" id="diag-wait">0ms</span>
                    </div>
                    <div class="status-item">
                        <span class="label">Queue</span>
                        <span class="value" id="diag-queue">0</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Stuck Requests -->
        <div class="card">
            <h2>Stuck Requests (>30s)</h2>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Age</th>
                            <th>Stage</th>
                            <th>Path</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="diag-stuck-table">
                        <tr>
                            <td colspan="5" style="text-align:center">No stuck requests</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Request Trace Table -->
        <div class="card">
            <h2>Recent Request Traces</h2>
            <div class="table-container" style="max-height: 500px; overflow-y: auto;">
                <table>
                    <thead>
                        <tr>
                            <th>Time</th>
                            <th>Method</th>
                            <th>Path</th>
                            <th>Status</th>
                            <th>Duration</th>
                            <th>Details</th>
                        </tr>
                    </thead>
                    <tbody id="diag-trace-table">
                        <tr>
                            <td colspan="6" style="text-align:center">Loading traces...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="app.js?v=2.9.7"></script>
</body>

</html>
```