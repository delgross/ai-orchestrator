<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Questionable Insight Dashboard</title>
    <link rel="stylesheet" href="/v2/styles.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&family=JetBrains+Mono:wght@400;500&display=swap"
        rel="stylesheet">
    <link rel="icon"
        href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>‚ùì</text></svg>">
</head>

<body class="space-theme">
    <!-- Fixed Indicator Strip (Top) -->
    <header class="indicator-strip glass">
        <div class="brand">
            <div class="logo-text">?</div>
            <h1>QUESTIONABLE INSIGHT</h1>
        </div>
        <div class="status-groups">
            <div class="status-item" id="status-router">
                <span class="label">ROUTER</span>
                <span class="indicator online"></span>
                <span class="value">--</span>
            </div>
            <!-- Moved MCP Tools Status here -->
            <div class="status-item" id="status-mcp-tools">
                <span class="label">MCP TOOLS</span>
                <span class="indicator online"></span>
                <span class="value">ENABLED</span>
            </div>
            <div class="status-item" id="status-mcp">
                <span class="label">AGENT</span>
                <span class="indicator online"></span>
                <span class="value">--</span>
            </div>
            <div class="status-item" id="status-ollama">
                <span class="label">OLLAMA</span>
                <span class="indicator pending"></span>
                <span class="value">--</span>
            </div>
            <div class="clock" id="clock">00:00:00</div>
            <div class="status-item" id="status-db">
                <span class="label">DATABASE</span>
                <span class="indicator online"></span>
                <span class="value">--</span>
            </div>
            <div class="status-item" id="status-internet">
                <span class="label">INTERNET</span>
                <span class="indicator online"></span>
                <span class="value">--</span>
            </div>
        </div>
        <div class="system-time" id="clock">00:00:00</div>
    </header>

    <!-- Quick Action / Launch Strip -->
    <div class="launch-strip glass">
        <button class="action-btn sm" onclick="location.reload()" title="Hard Refresh Dashboard">
            <span class="icon">üîÉ</span> Refresh UI
        </button>
        <button class="action-btn sm" onclick="window.open('/v2/mcp_wizard.html', '_blank')">
            <span class="icon">‚ú®</span> Import MCP Server
        </button>
        <button class="action-btn sm" onclick="window.location.href='/v2/chat_debug.html'"
            title="Graph Visualization & Debugging">
            <span class="icon">üï∏Ô∏è</span> Graph View
        </button>
        <button class="action-btn sm" id="btn-reload-mcp-top" title="Reload MCP Servers">
            <span class="icon">üîÑ</span> Reload MCP
        </button>
        <button class="action-btn sm" id="btn-toggle-auto-top">
            <span class="icon">ü§ñ</span> Auto: <span id="lbl-auto">ON</span>
        </button>
        <button class="action-btn sm" id="btn-trigger-backup-top" title="Run Manual Backup">
            <span class="icon">üíæ</span> Backup
        </button>
        <button class="action-btn sm" id="btn-health-check">
            <span class="icon">ü©∫</span> Run Health Check
        </button>
        <div style="width:1px; height:24px; background:var(--glass-border); margin:0 0.5rem;"></div>
        <button class="action-btn sm"
            onclick="fetch('/admin/system/process/router/restart', {method:'POST'}).then(() => alert('Router restarting...'))"
            title="Restart Router Process">
            <span class="icon">üîÑ</span> Router
        </button>
        <button class="action-btn sm"
            onclick="fetch('/admin/system/process/agent/restart', {method:'POST'}).then(() => alert('Agent restarting...'))"
            title="Restart Agent Process">
            <span class="icon">üß†</span> Agent
        </button>
    </div>

    <main class="dashboard-container">
        <!-- Tab Navigation -->
        <nav class="tab-strip glass">
            <button class="tab-link active" data-tab="overview">
                <span class="icon">üìä</span> Overview
            </button>
            <button class="tab-link" data-tab="ollama">
                <span class="icon">ü¶ô</span> Ollama
            </button>
            <button class="tab-link" data-tab="tools">
                <span class="icon">üîß</span> MCP Servers
            </button>
            <button class="tab-link" data-tab="cost">
                <span class="icon">üí∞</span> Cost
            </button>
            <button class="tab-link" data-tab="docs">
                <span class="icon">üìö</span> Docs
            </button>
            <button class="tab-link" data-tab="config">
                <span class="icon">‚öôÔ∏è</span> Config
            </button>
            <button class="tab-link" data-tab="misc">
                <span class="icon">üß©</span> Misc
            </button>
            <button class="tab-link" data-tab="chat">
                <span class="icon">üí¨</span> Chat
            </button>
            <button class="tab-link" data-tab="logs">
                <span class="icon">üìù</span> Logs
            </button>
        </nav>

        <!-- View Content Area -->
        <section class="tab-views">
            <!-- Chat Tab -->
            <div id="chat" class="tab-content">
                <div class="card glass wide full-height" style="display: flex; flex-direction: column;">
                    <div class="card-header">
                        <h3>Direct Router Chat</h3>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <select id="chat-model-select" class="config-select">
                                <option value="agent:mcp">Orchestrator (Agent)</option>
                                <option value="router">Raw Router</option>
                            </select>
                            <span id="chat-status" class="status-indicator">Ready</span>
                        </div>
                    </div>
                    <div id="chat-messages" class="chat-container mono"
                        style="flex-grow: 1; overflow-y: auto; padding: 20px; background: rgba(0,0,0,0.2); border-radius: 8px; margin-bottom: 20px;">
                        <div class="chat-message system">System: Ready to connect to Port 5455.</div>
                    </div>
                    <div class="chat-input-area" style="display: flex; gap: 10px; align-items: flex-end;">
                        <button id="btn-chat-mic" class="action-btn sm"
                            style="padding: 0 15px; height: 60px; background: #333;" title="Voice Input">üé§</button>
                        <textarea id="chat-input" class="code-editor"
                            style="height: 60px; min-height: 60px; flex-grow: 1;"
                            placeholder="Type your message... (Shift+Enter to send)"></textarea>
                        <button id="btn-chat-send" class="action-btn primary" style="height: 60px;">Send</button>
                    </div>
                    <div style="margin-top: 10px; display: flex; gap: 15px; align-items: center;">
                        <label
                            style="color: #aaa; font-size: 0.8em; cursor: pointer; display: flex; align-items: center; gap: 6px;">
                            <input type="checkbox" id="chat-tts-toggle"> üîä Read Responses Aloud
                        </label>
                    </div>
                </div>
            </div>
            <!-- Overview Tab -->
            <div id="overview" class="tab-content active show">
                <div class="grid-layout">
                    <!-- System Role & Model Orchestration (Left / Top) -->
                    <div class="card glass wide full-width" style="grid-column: span 2;">
                        <div class="card-header">
                            <h3>System Role & Model Orchestration</h3>
                            <button class="action-btn sm" onclick="fetchSystemRoles()">Refresh Roles</button>
                        </div>
                        <div class="role-table-container">
                            <table class="role-table">
                                <thead>
                                    <tr>
                                        <th>Role</th>
                                        <th>Current Assigned Model</th>
                                        <th>Select New Model</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody id="roles-table-body">
                                    <tr>
                                        <td colspan="4" class="text-center">Loading Roles...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Active Ports & Connectivity -->
                    <div class="card">
                        <h3>Active Ports & Connectivity</h3>
                        <div style="font-size: 0.9em; color: var(--text-secondary); margin-bottom: 10px;">
                            Critical endpoints for connecting external tools to the Orchestrator.
                        </div>
                        <table class="status-table">
                            <thead>
                                <tr>
                                    <th align="left">Port</th>
                                    <th align="left">Service</th>
                                    <th align="left">Function</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td class="mono" style="color:var(--accent-ok);">5455</td>
                                    <td style="font-weight:600;">Router (Gateway)</td>
                                    <td>Main Entry Point. Connect LibreChat/RAG here.</td>
                                </tr>
                                <tr>
                                    <td class="mono" style="color:var(--accent-ok);">5460</td>
                                    <td style="font-weight:600;">Agent Runner</td>
                                    <td>The Brain. Handles MCP tools & logic.</td>
                                </tr>
                                <tr>
                                    <td class="mono" style="color:var(--accent-warn);">11434</td>
                                    <td style="font-weight:600;">Ollama</td>
                                    <td>Local LLM Engine (Backend).</td>
                                </tr>
                                <tr>
                                    <td class="mono" style="color:var(--text-secondary);">8000</td>
                                    <td style="font-weight:600;">SurrealDB</td>
                                    <td>Memory & Vector Database.</td>
                                </tr>
                                <tr>
                                    <td class="mono" style="color:var(--accent-neon);">3080</td>
                                    <td style="font-weight:600;">LibreChat</td>
                                    <td>User Interface (Web Client).</td>
                                </tr>
                                <tr>
                                    <td class="mono" style="color:var(--text-secondary);">3000</td>
                                    <td style="font-weight:600;">Open WebUI / Dev</td>
                                    <td>Alternate User Interface.</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Metrics Card -->
                    <div class="card glass tall">
                        <h3>System Metrics</h3>
                        <div class="metrics-visual">
                            <div class="chart-placeholder">
                                <div class="chart-bar" style="height: 40%"></div>
                                <div class="chart-bar" style="height: 60%"></div>
                                <div class="chart-bar" style="height: 30%"></div>
                                <div class="chart-bar" style="height: 80%"></div>
                                <div class="chart-bar" style="height: 50%"></div>
                            </div>
                        </div>
                        <div class="metric-row">
                            <span class="label">Total Requests</span>
                            <span class="value big" id="metric-requests">0</span>
                        </div>
                        <div class="metric-row">
                            <span class="label">Avg Latency</span>
                            <span class="value big" id="metric-latency">0ms</span>
                        </div>
                        <div class="metric-row">
                            <span class="label">Cache Hit Rate</span>
                            <span class="value big" id="metric-cache">0%</span>
                        </div>
                        <div class="metric-row">
                            <span class="label">Error Rate</span>
                            <span class="value big" id="metric-errors">0%</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Ollama Manager Tab -->
            <div id="ollama" class="tab-content">
                <div class="card glass wide full-height">
                    <div class="card-header">
                        <h3>Ollama Model Management</h3>
                        <div class="status-msg" id="ollama-status-msg"></div>
                    </div>
                    <div id="ollama-models-grid" class="mcp-grid">
                        <!-- Populated by JS -->
                        <div class="placeholder-box">Loading models...</div>
                    </div>
                </div>
            </div>

            <!-- Documents Tab -->
            <div id="docs" class="tab-content">
                <div class="grid-layout">
                    <!-- File List -->
                    <div class="card glass" style="max-height: 80vh; overflow-y: auto;">
                        <h3>Available Documents</h3>
                        <div id="docs-list" class="task-list">
                            <div class="placeholder-box">Loading docs...</div>
                        </div>
                    </div>
                    <!-- Viewer -->
                    <div class="card glass wide" style="max-height: 80vh; overflow-y: auto;">
                        <h3 id="doc-viewer-title">Reader</h3>
                        <div id="doc-viewer-content" class="md-content">
                            Select a document to view.
                        </div>
                    </div>
                </div>
            </div>

            <!-- MCP Tools Tab -->
            <div id="tools" class="tab-content">
                <div class="card glass wide full-height">
                    <div class="card-header">
                        <h3>MCP Servers & Tools</h3>
                        <div class="search-box">
                            <input type="text" id="tool-search" placeholder="Filter servers...">
                        </div>
                    </div>
                    <div id="mcp-servers-list" class="mcp-grid">
                        <div class="placeholder-box">Loading MCP Servers...</div>
                    </div>
                </div>
            </div>

            <!-- Cost Tab -->
            <div id="cost" class="tab-content">
                <div class="card glass">
                    <h3>Daily API Budget</h3>
                    <div style="display:flex; justify-content:space-between; align-items:flex-end; margin-bottom:1rem;">
                        <div>
                            <div style="font-size:3rem; font-weight:700;" id="costDisplay">Loading...</div>
                            <div style="color:var(--text-secondary);" id="limitDisplay">Limit: --</div>
                        </div>
                        <div style="text-align:right;">
                            <div style="font-size:1.5rem; font-weight:bold;" id="percentDisplay">--%</div>
                            <div style="font-size:0.8rem; color:var(--text-secondary);">Used Today</div>
                        </div>
                    </div>

                    <div style="background:rgba(255,255,255,0.1); height:10px; border-radius:5px; overflow:hidden;">
                        <div id="costBar"
                            style="width:0%; height:100%; background:var(--success); transition:width 0.5s;"></div>
                    </div>

                    <p style="margin-top:1rem; font-size:0.9rem; color:var(--text-secondary);">
                        Estimates based on input/output tokens. Actual provider billing may vary slightly.
                        Resets daily at 00:00 UTC.
                    </p>
                    <button class="action-btn sm" onclick="refreshCost()" style="margin-top:1rem;">üîÑ Refresh
                        Cost</button>
                </div>
            </div>

            <!-- Misc Tab -->
            <div id="misc" class="tab-content">
                <div class="grid-layout">
                    <div class="card glass wide">
                        <h3>Full Provider Status</h3>
                        <div id="llm-status-list-misc" class="mcp-grid">
                            <div class="placeholder-box">Loading Status...</div>
                        </div>
                    </div>

                    <div class="card glass">
                        <h3>System Controls</h3>
                        <div style="display:flex; flex-direction:column; gap:0.8rem;">
                            <button class="action-btn"
                                onclick="fetch('/admin/reload', {method:'POST'}).then(()=>location.reload())">
                                ‚ö° Hot Reload Config
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Config Edit Tab (Smart) -->
            <div id="config" class="tab-content">
                <div class="grid-layout">
                    <!-- Control Panel -->
                    <div class="card glass" style="grid-column: span 1;">
                        <h3>‚ú® Smart Config Manager</h3>
                        <p style="color:var(--text-secondary); font-size:0.9rem; margin-bottom:1rem;">
                            Describe the changes you want (e.g., "Remove the fetch-docker server", "Set timeout to 600",
                            "Enable debug mode").
                            The Agent will safely edit <code>config.yaml</code> for you.
                        </p>

                        <textarea id="config-instruction" class="code-editor" style="height:150px; margin-bottom:1rem;"
                            placeholder="Type your instructions here..."></textarea>

                        <div class="controls" style="display:flex; justify-content:space-between; align-items:center;">
                            <button class="action-btn primary" id="btn-smart-config" onclick="runSmartConfig()">ü§ñ Apply
                                Changes</button>
                            <span id="smart-config-status" class="status-msg"></span>
                        </div>

                        <div id="smart-config-log" class="log-viewer mono"
                            style="margin-top:1rem; height:200px; font-size:0.8rem; background:rgba(0,0,0,0.3);">
                            Agent output will appear here...
                        </div>
                    </div>

                    <!-- File Viewer (Read Only reference) -->
                    <div class="card glass" style="grid-column: span 1;">
                        <div class="card-header">
                            <h3>Current Config (Read-Only)</h3>
                            <button class="action-btn sm" onclick="loadConfigFile()">üîÑ Refresh View</button>
                        </div>
                        <textarea id="config-editor" class="code-editor mono" readonly
                            style="height: 400px; opacity: 0.8; background: #111;"
                            placeholder="Loading config..."></textarea>
                    </div>
                </div>
            </div>

            <!-- Logs Tab -->
            <div id="logs" class="tab-content">
                <div class="card glass wide full-height">
                    <div class="card-header">
                        <h3>System Logs (Live Stream)</h3>
                        <div class="log-controls">
                            <button class="action-btn sm" id="btn-refresh-logs">Refresh Tail</button>
                            <button class="action-btn sm" id="btn-clear-logs">Clear View</button>
                        </div>
                    </div>
                    <div id="log-container" class="log-viewer mono">
                        <div class="log-entry info">System: Initializing log stream...</div>
                    </div>
                </div>
            </div>

        </section>
    </main>

    <!-- Cleaned Footer -->
    <footer class="toggle-strip glass">
        <div class="mode-indicator" id="system-mode">
            MODE: <span class="value">PRODUCTION</span>
        </div>
    </footer>

    <!-- Tool Modal -->
    <div id="tool-modal" class="modal-overlay">
        <div class="modal glass">
            <div class="modal-header">
                <h3 id="modal-title">Tool Details</h3>
                <button class="close-modal">&times;</button>
            </div>
            <div class="modal-body" id="modal-content">
                <!-- Content injected here -->
            </div>
        </div>
    </div>

    <!-- Models Modal (Still kept for view all if needed) -->
    <div id="model-modal" class="modal-overlay">
        <div class="modal glass">
            <div class="modal-header">
                <h3 id="model-modal-title">Available Models</h3>
                <button class="close-modal">&times;</button>
            </div>
            <div class="modal-body" id="model-modal-content">
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="/v2/app.js?v=2.8.5"></script>
</body>

</html>